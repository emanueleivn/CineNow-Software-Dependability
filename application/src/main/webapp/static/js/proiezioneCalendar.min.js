/* proiezioneCalendar.min.js - Script per il calendario proiezioni */
$(document).ready(function(){let durataFilm=0;function caricaCalendario(){$(".error-msg").remove();$("#calendar-container").html("");const filmId=$("#film").val();const dataInizio=$("#dataInizio").val();const dataFine=$("#dataFine").val();const salaId=$("#sala").val();if(filmId&&dataInizio&&dataFine&&salaId){const oggi=new Date().toISOString().split('T')[0];if(dataInizio<oggi){$("#calendar-container").html("<p class='error-msg'>La data di inizio non può essere precedente ad oggi.</p>");return}if(dataInizio>dataFine){$("#calendar-container").html("<p class='error-msg'>La data di inizio non può essere successiva alla data di fine.</p>");return}$.ajax({url:window.contextPath+"/slotDisponibili",method:'GET',dataType:'json',data:{filmId,salaId,dataInizio,dataFine},success:function(resp){durataFilm=resp.durataFilm||0;if(resp.calendar&&resp.calendar.length>0){const orariSet=new Set();resp.calendar.forEach(g=>{g.slots.forEach(s=>orariSet.add(s.oraInizio))});const orariArray=Array.from(orariSet).sort();let table="<table><thead><tr><th>Orario</th>";resp.calendar.forEach(g=>{table+="<th>"+g.data+"</th>"});table+="</tr></thead><tbody>";orariArray.forEach(ora=>{table+="<tr><td><b>"+ora+"</b></td>";resp.calendar.forEach(g=>{const found=g.slots.find(x=>x.oraInizio===ora);if(!found){table+="<td class='slot-unavailable'>--</td>"}else if(found.occupato){table+="<td class='slot-unavailable'>"+found.film+"</td>"}else{table+="<td class='slot-available' data-id='"+found.id+"' data-day='"+g.data+"' data-orainizio='"+found.oraInizio+"'>Disponibile</td>"}});table+="</tr>"});table+="</tbody></table>";$("#calendar-container").html(table);$(".slot-available").click(function(){$(".slot-selected").removeClass("slot-selected");const blocchi=Math.ceil(durataFilm/30);const startRow=$(this).closest("tr").index();const colIndex=$(this).index();const $tbody=$(this).closest("tbody");let validSelection=true;let slotsUsed=0;for(let i=0;i<blocchi;i++){const $row=$tbody.find("tr").eq(startRow+i);const $slot=$row.find("td").eq(colIndex);if($slot.length===0){slotsUsed++;continue}if($slot.hasClass("slot-unavailable")){validSelection=false;break}$slot.addClass("slot-selected");slotsUsed++}$(".error-msg").remove();if(!validSelection||slotsUsed<blocchi){$("#calendar-container").after("<p class='error-msg'>Non ci sono abbastanza slot disponibili per questa proiezione.</p>");$(".slot-selected").removeClass("slot-selected")}})}else{$("#calendar-container").html("<p>Nessuno slot disponibile.</p>")}},error:function(){$("#calendar-container").html("<p class='error-msg'>Errore nel caricamento del calendario.</p>")}})}}$("#film, #dataInizio, #dataFine, #sala").change(caricaCalendario);$("form").submit(function(e){$("input[name='slot']").remove();const selectedSlots=$(".slot-selected");if(selectedSlots.length===0){alert("Bisogna selezionare almeno uno slot per aggiungere una proiezione.");e.preventDefault();return}selectedSlots.each(function(){const slotId=$(this).data("id");const day=$(this).data("day");$("<input>").attr("type","hidden").attr("name","slot").val(slotId+":"+day).appendTo("form")})})});

